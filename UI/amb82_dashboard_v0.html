<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentryNet | History & Results</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========== GLOBAL STYLES (MATCHING INDEX 3) ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: #f8f6f1; 
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        header {
            padding: 1.5rem 2rem;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            z-index: 10;
        }
        .brand h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; margin: 0; }
        .brand p { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.15em; margin: 2px 0 0 0; }
        
        .refresh-btn {
            background: #1a1a1a;
            color: #fff;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover { background: #333; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* ========== MAIN LAYOUT ========== */
        .dashboard-wrapper {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        /* --- LEFT SIDEBAR (HISTORY) --- */
        .sidebar {
            width: 320px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .history-item {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .history-item:hover { background: #fbfbfb; }
        .history-item.active { background: #f0f0f0; border-right: 4px solid #1a1a1a; }
        
        .h-time { font-size: 0.85rem; color: #666; margin-bottom: 4px; }
        .h-title { font-weight: 700; font-size: 1rem; color: #1a1a1a; margin-bottom: 4px; }
        .h-meta { display: flex; gap: 8px; font-size: 0.75rem; color: #888; }
        .tag { background: #eee; padding: 2px 6px; border-radius: 4px; }
        .tag.alert { background: #ffebee; color: #c62828; }

        /* --- RIGHT CONTENT (RESULTS) --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        .empty-state {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            text-align: center;
        }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        /* --- VIDEO PLAYER SECTION --- */
        .video-wrapper {
            width: 100%;
            max-width: 900px;
            margin: 0 auto 2rem auto;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        video { width: 100%; display: block; max-height: 500px; }

        /* --- RESULTS GRID (COPIED FROM INDEX 3) --- */
        .results-container { max-width: 900px; margin: 0 auto; }
        
        .species-section {
            margin-bottom: 3rem;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .species-header {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;
            padding-bottom: 1rem; border-bottom: 2px solid #eee;
        }
        .species-title { font-size: 1.5rem; font-weight: 700; color: #1a1a1a; }
        .species-count { background: #eee; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; color: #666; }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .thumb-card {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .thumb-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        
        .thumb-img {
            width: 100%; height: 140px; object-fit: cover; cursor: zoom-in; display: block;
        }
        .thumb-content {
            padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; align-items: center;
        }

        .btn-timestamp {
            background: transparent;
            border: 2px solid #1a1a1a;
            color: #1a1a1a;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }
        .btn-timestamp:hover { background: #1a1a1a; color: #fff; }
        
        .confidence-badge { font-size: 0.8rem; color: #888; font-weight: 600; }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(248, 246, 241, 0.95);
            backdrop-filter: blur(8px); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-img {
            max-width: 90%; max-height: 85vh; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .close-modal {
            position: absolute; top: 30px; right: 30px; width: 40px; height: 40px;
            background: #1a1a1a; color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.5rem;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <h1>AMB82 Sentry Results</h1>
            <p>IoT Video Intelligence Log</p>
        </div>
        <button class="refresh-btn" onclick="loadHistory()">‚Üª Refresh Data</button>
    </header>

    <div class="dashboard-wrapper">
        
        <div class="sidebar">
            <div class="sidebar-header">Recent Captures</div>
            <div id="historyList">
                <div style="padding: 2rem; text-align: center; color: #aaa;">Loading...</div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            
            <div id="welcomeState" class="empty-state">
                <div class="empty-icon">üìÅ</div>
                <h2>Select a capture</h2>
                <p>Choose a video from the sidebar to view analysis.</p>
            </div>

            <div id="resultsView" style="display: none;">
                <div class="video-wrapper">
                    <video id="mainPlayer" controls playsinline>
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div class="results-container" id="resultsGrid">
                    </div>
            </div>

        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="close-modal">√ó</div>
        <img class="modal-img" id="modalImg">
    </div>

    <script>
        // API Endpoints
        const API_HISTORY = '/api/history';
        const VIDEO_BASE_PATH = '/uploads/videos/'; // Assumes you serve this folder

        let currentHistoryData = [];

        // 1. Load History List
        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            
            try {
                const response = await fetch(API_HISTORY);
                const data = await response.json();
                currentHistoryData = data;

                if (data.length === 0) {
                    listContainer.innerHTML = '<div style="padding:2rem; text-align:center;">No videos found.</div>';
                    return;
                }

                listContainer.innerHTML = '';
                
                data.forEach((item, index) => {
                    // Count unique species
                    const speciesSet = new Set(item.detections.map(d => d.species));
                    const uniqueCount = speciesSet.size;
                    const totalCount = item.detections.length;

                    // Format Date
                    const dateObj = new Date(item.time);
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const dateStr = dateObj.toLocaleDateString();

                    const el = document.createElement('div');
                    el.className = 'history-item';
                    el.onclick = () => selectVideo(index);
                    el.innerHTML = `
                        <div class="h-time">${dateStr} ‚Ä¢ ${timeStr}</div>
                        <div class="h-title">Capture #${item.id}</div>
                        <div class="h-meta">
                            <span class="tag">${uniqueCount} Species</span>
                            <span class="tag">${totalCount} Events</span>
                        </div>
                    `;
                    listContainer.appendChild(el);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="padding:2rem; text-align:center; color:red;">Error loading history.</div>';
            }
        }

        // 2. Select & Display Video
        function selectVideo(index) {
            const data = currentHistoryData[index];
            if (!data) return;

            // Highlight Sidebar Item
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.history-item')[index].classList.add('active');

            // Show Views
            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('resultsView').style.display = 'block';

            // Load Video
            // NOTE: Assumes filename is stored cleanly in DB or API returns full path
            const player = document.getElementById('mainPlayer');
            // Remove 'uploads/videos/' if duplicate in filename
            const cleanFilename = data.filename.replace('uploads/videos/', '');
            player.src = `${VIDEO_BASE_PATH}${cleanFilename}`; 
            player.load();

            // Render Results
            renderResultsGrid(data.detections);
        }

        // 3. Render Grid (Same logic as index 3)
        function renderResultsGrid(detections) {
            const container = document.getElementById('resultsGrid');
            container.innerHTML = '';

            if (!detections || detections.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#888;">No detections found in this video.</div>';
                return;
            }

            // Group by Species
            const bySpecies = {};
            detections.forEach(d => {
                if (!bySpecies[d.species]) bySpecies[d.species] = [];
                bySpecies[d.species].push(d);
            });

            // Create Sections
            for (const [species, dets] of Object.entries(bySpecies)) {
                // Sort by time
                dets.sort((a, b) => a.time - b.time);

                const section = document.createElement('div');
                section.className = 'species-section';
                
                let html = `
                    <div class="species-header">
                        <h3 class="species-title">${species}</h3>
                        <span class="species-count">${dets.length} sightings</span>
                    </div>
                    <div class="video-grid">
                `;

                dets.forEach(d => {
                    const timeLabel = formatTime(d.time);
                    // Handle image URL (ensure / prefix)
                    const imgUrl = d.image_url ? (d.image_url.startsWith('/') ? d.image_url : '/' + d.image_url) : '';

                       html += `
    <div class="thumb-card">
        <img src="${imgUrl}" 
             class="thumb-img" 
             onclick="openModal('${imgUrl}')" 
             loading="lazy"
             onerror="this.onerror=null; this.src='https://placehold.co/600x400/1a1a1a/FFF?text=Image+Lost';">
        
        <div class="thumb-content">
                                <button class="btn-timestamp" onclick="seekVideo(${d.time})">
                                    ‚ñ∂ ${timeLabel}
                                </button>
                                <span class="confidence-badge">Confidence: High</span>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                section.innerHTML = html;
                container.appendChild(section);
            }
        }

        // 4. Video Helpers
        function seekVideo(seconds) {
            const player = document.getElementById('mainPlayer');
            player.currentTime = seconds;
            player.play();
            player.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // 5. Modal Helpers
        function openModal(url) {
            document.getElementById('modalImg').src = url;
            document.getElementById('imageModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // Initialize
        loadHistory();

    </script>
</body>
</html>
